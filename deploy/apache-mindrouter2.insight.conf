<VirtualHost *:80>
        ServerName mindrouter2.insight.uidaho.edu
        Redirect permanent / https://mindrouter2.insight.uidaho.edu/
        ErrorLog /var/log/httpd/mindrouter2-dev-error_log
        CustomLog /var/log/httpd/mindrouter2-dev-access_log combined
</VirtualHost>

<VirtualHost *:443>
        ServerName mindrouter2.insight.uidaho.edu

        SSLEngine on
        SSLProtocol -ALL +TLSv1.2 +TLSv1.3
        SSLHonorCipherOrder on
        SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4+RSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !SHA1"
        SSLCertificateKeyFile /etc/httpd/ssl/nkn-san.key
        SSLCertificateFile /etc/httpd/ssl/nkn-san.crt
        SSLCertificateChainFile /etc/httpd/ssl/InCommonRSAServerCA_2.crt

        # Reverse proxy to MindRouter2 app
        ProxyRequests Off
        ProxyPreserveHost On

        # WebSocket support for streaming responses
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) ws://127.0.0.1:8000/$1 [P,L]

        # Main proxy
        ProxyPass / http://127.0.0.1:8000/
        ProxyPassReverse / http://127.0.0.1:8000/

        # Increase timeout for long-running LLM requests (10 minutes)
        ProxyTimeout 600

        # Pass client info to backend
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY"
        Header always set X-XSS-Protection "1; mode=block"

        # Allow large request bodies for file uploads (50MB)
        LimitRequestBody 52428800

        CustomLog /var/log/httpd/mindrouter2-dev-access_log combined
        ErrorLog /var/log/httpd/mindrouter2-dev-error_log
</VirtualHost>
