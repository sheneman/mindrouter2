{% extends "base.html" %}

{% block title %}Model Management - MindRouter2{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        {% set active = "models" %}{% include "admin/_sidebar.html" %}

        <!-- Main Content -->
        <div class="col-md-10 py-3">
            <h1 class="mb-4"><i class="bi bi-boxes"></i> Model Management</h1>

            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i>
                {% if success == 'updated' %}Multimodal setting updated.
                {% elif success == 'reset' %}Multimodal override reset to auto-detect.
                {% else %}Operation completed successfully.{% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <p class="text-muted mb-3">{{ grouped_models|length }} unique model{{ 's' if grouped_models|length != 1 }} across all backends</p>

            {% if grouped_models %}
            <div class="accordion" id="modelsAccordion">
                {% for model_name, instances in grouped_models.items() %}
                {% set first = instances[0] %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#model-{{ loop.index }}">
                            <span class="me-3"><code>{{ model_name }}</code></span>
                            <span class="badge bg-info me-2">{{ instances|length }} endpoint{{ 's' if instances|length > 1 }}</span>
                            {% if first.supports_multimodal %}
                            <span class="badge bg-success me-2">Multimodal</span>
                            {% endif %}
                            {% if first.context_length %}
                            <span class="badge bg-secondary me-2">{{ '{:,}'.format(first.context_length) }} ctx</span>
                            {% endif %}
                            {% if first.parameter_count %}
                            <span class="badge bg-secondary me-2">{{ first.parameter_count }}</span>
                            {% endif %}
                            {% if first.quantization %}
                            <span class="badge bg-warning text-dark me-2">{{ first.quantization }}</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="model-{{ loop.index }}" class="accordion-collapse collapse"
                         data-bs-parent="#modelsAccordion">
                        <div class="accordion-body">
                            <!-- Capabilities badges -->
                            {% if first.capabilities %}
                            {% set cap_list = first.capabilities | fromjson if first.capabilities is string else [] %}
                            {% if cap_list %}
                            <div class="mb-3">
                                <h6>Capabilities</h6>
                                {% for cap in cap_list %}
                                {% if cap == 'completion' %}
                                <span class="badge bg-primary me-1">completion</span>
                                {% elif cap == 'vision' %}
                                <span class="badge bg-success me-1">vision</span>
                                {% elif cap == 'tools' %}
                                <span class="badge bg-purple me-1" style="background-color: #6f42c1 !important;">tools</span>
                                {% elif cap == 'embedding' %}
                                <span class="badge bg-info me-1">embedding</span>
                                {% else %}
                                <span class="badge bg-secondary me-1">{{ cap }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}

                            <div class="row mb-3">
                                <!-- Model Details -->
                                <div class="col-md-6">
                                    <h6>Model Details</h6>
                                    <dl class="row small mb-0">
                                        <dt class="col-5">Family:</dt>
                                        <dd class="col-7">{{ first.family or 'Unknown' }}</dd>
                                        <dt class="col-5">Context Length:</dt>
                                        <dd class="col-7">{{ '{:,}'.format(first.context_length) if first.context_length else 'Unknown' }}</dd>
                                        <dt class="col-5">Parameters:</dt>
                                        <dd class="col-7">{{ first.parameter_count or 'Unknown' }}</dd>
                                        <dt class="col-5">Quantization:</dt>
                                        <dd class="col-7">{{ first.quantization or 'N/A' }}</dd>
                                        <dt class="col-5">Modality:</dt>
                                        <dd class="col-7">{{ first.modality.value }}</dd>
                                        {% if first.model_format %}
                                        <dt class="col-5">Format:</dt>
                                        <dd class="col-7">{{ first.model_format }}</dd>
                                        {% endif %}
                                        {% if first.parent_model %}
                                        <dt class="col-5">Parent Model:</dt>
                                        <dd class="col-7"><small>{{ first.parent_model }}</small></dd>
                                        {% endif %}
                                    </dl>
                                </div>

                                <!-- Multimodal Control -->
                                <div class="col-md-6">
                                    <h6>Multimodal Setting</h6>
                                    <div class="card">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <span>
                                                    {% if first.supports_multimodal %}
                                                    <span class="badge bg-success">Multimodal: ON</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Multimodal: OFF</span>
                                                    {% endif %}
                                                </span>
                                                <span>
                                                    {% if first.multimodal_override is not none %}
                                                    <span class="badge bg-info">Manual Override</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Auto-detected</span>
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div>
                                                <form method="POST" action="/admin/models/toggle-multimodal" class="d-inline">
                                                    <input type="hidden" name="model_name" value="{{ model_name }}">
                                                    <button type="submit" class="btn btn-sm {{ 'btn-outline-warning' if first.supports_multimodal else 'btn-outline-success' }}">
                                                        <i class="bi {{ 'bi-toggle-on' if first.supports_multimodal else 'bi-toggle-off' }}"></i>
                                                        {{ 'Disable' if first.supports_multimodal else 'Enable' }} Multimodal
                                                    </button>
                                                </form>
                                                {% if first.multimodal_override is not none %}
                                                <form method="POST" action="/admin/models/reset-multimodal" class="d-inline">
                                                    <input type="hidden" name="model_name" value="{{ model_name }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Auto
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Architecture Details (Ollama only) -->
                            {% if first.embedding_length or first.head_count or first.layer_count or first.feed_forward_length %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6>Architecture</h6>
                                    <div class="d-flex flex-wrap gap-3 small">
                                        {% if first.embedding_length %}
                                        <div><strong>Embedding Dim:</strong> {{ '{:,}'.format(first.embedding_length) }}</div>
                                        {% endif %}
                                        {% if first.head_count %}
                                        <div><strong>Attention Heads:</strong> {{ first.head_count }}</div>
                                        {% endif %}
                                        {% if first.layer_count %}
                                        <div><strong>Layers:</strong> {{ first.layer_count }}</div>
                                        {% endif %}
                                        {% if first.feed_forward_length %}
                                        <div><strong>FFN Size:</strong> {{ '{:,}'.format(first.feed_forward_length) }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Endpoints Table -->
                            <h6>Deployed Endpoints</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Backend</th>
                                            <th>Engine</th>
                                            <th>URL</th>
                                            <th>Status</th>
                                            <th>Loaded</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for m in instances %}
                                        <tr>
                                            <td>{{ m.backend.name if m.backend else '-' }}</td>
                                            <td>
                                                {% if m.backend %}
                                                <span class="badge bg-primary">{{ m.backend.engine.value }}</span>
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            <td><small class="text-muted">{{ m.backend.url if m.backend else '-' }}</small></td>
                                            <td>
                                                {% if m.backend and m.backend.status.value == 'healthy' %}
                                                <span class="badge bg-success">Healthy</span>
                                                {% elif m.backend %}
                                                <span class="badge bg-danger">{{ m.backend.status.value }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if m.is_loaded %}
                                                <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No models discovered yet. Models will appear here once backends are registered and polled.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
