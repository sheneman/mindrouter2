{% extends "base.html" %}

{% block title %}Model Management - MindRouter2{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        {% set active = "models" %}{% include "admin/_sidebar.html" %}

        <!-- Main Content -->
        <div class="col-md-10 py-3">
            <h1 class="mb-4"><i class="bi bi-boxes"></i> Model Management</h1>

            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i>
                {% if success == 'updated' %}Multimodal setting updated.
                {% elif success == 'reset' %}Multimodal override reset to auto-detect.
                {% elif success == 'metadata_updated' %}Model metadata overrides saved.
                {% elif success == 'overrides_reset' %}All metadata overrides cleared.
                {% else %}Operation completed successfully.{% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <p class="text-muted mb-3">{{ grouped_models|length }} unique model{{ 's' if grouped_models|length != 1 }} across all backends</p>

            {% if grouped_models %}
            <div class="accordion" id="modelsAccordion">
                {% for model_name, instances in grouped_models.items() %}
                {% set first = instances[0] %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#model-{{ loop.index }}">
                            <span class="me-3"><code>{{ model_name }}</code></span>
                            <span class="badge bg-info me-2">{{ instances|length }} endpoint{{ 's' if instances|length > 1 }}</span>
                            {% if first.supports_multimodal %}
                            <span class="badge bg-success me-2">Multimodal</span>
                            {% endif %}
                            {% if first.context_length %}
                            <span class="badge bg-secondary me-2">{{ '{:,}'.format(first.context_length) }} ctx</span>
                            {% endif %}
                            {% if first.parameter_count %}
                            <span class="badge bg-secondary me-2">{{ first.parameter_count }}</span>
                            {% endif %}
                            {% if first.quantization %}
                            <span class="badge bg-warning text-dark me-2">{{ first.quantization }}</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="model-{{ loop.index }}" class="accordion-collapse collapse"
                         data-bs-parent="#modelsAccordion">
                        <div class="accordion-body">
                            <!-- Capabilities badges -->
                            {% if first.capabilities %}
                            {% set cap_list = first.capabilities | fromjson if first.capabilities is string else [] %}
                            {% if cap_list %}
                            <div class="mb-3">
                                <h6>Capabilities</h6>
                                {% for cap in cap_list %}
                                {% if cap == 'completion' %}
                                <span class="badge bg-primary me-1">completion</span>
                                {% elif cap == 'vision' %}
                                <span class="badge bg-success me-1">vision</span>
                                {% elif cap == 'tools' %}
                                <span class="badge bg-purple me-1" style="background-color: #6f42c1 !important;">tools</span>
                                {% elif cap == 'embedding' %}
                                <span class="badge bg-info me-1">embedding</span>
                                {% else %}
                                <span class="badge bg-secondary me-1">{{ cap }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}

                            <div class="row mb-3">
                                <!-- Model Details -->
                                <div class="col-md-6">
                                    <h6>Model Details</h6>
                                    <dl class="row small mb-0">
                                        <dt class="col-5">Family:</dt>
                                        <dd class="col-7">{{ first.family or 'Unknown' }}{% if first.family_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        <dt class="col-5">Context Length:</dt>
                                        <dd class="col-7">{{ '{:,}'.format(first.context_length) if first.context_length else 'Unknown' }}{% if first.context_length_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        {% if first.model_max_context and first.model_max_context != first.context_length %}
                                        <dt class="col-5">Model Max:</dt>
                                        <dd class="col-7">{{ '{:,}'.format(first.model_max_context) }}</dd>
                                        {% endif %}
                                        <dt class="col-5">Parameters:</dt>
                                        <dd class="col-7">{{ first.parameter_count or 'Unknown' }}{% if first.parameter_count_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        <dt class="col-5">Quantization:</dt>
                                        <dd class="col-7">{{ first.quantization or 'N/A' }}{% if first.quantization_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        <dt class="col-5">Modality:</dt>
                                        <dd class="col-7">{{ first.modality.value }}</dd>
                                        {% if first.model_format %}
                                        <dt class="col-5">Format:</dt>
                                        <dd class="col-7">{{ first.model_format }}{% if first.model_format_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        {% endif %}
                                        {% if first.parent_model %}
                                        <dt class="col-5">Parent Model:</dt>
                                        <dd class="col-7"><small>{{ first.parent_model }}</small>{% if first.parent_model_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</dd>
                                        {% endif %}
                                    </dl>
                                </div>

                                <!-- Multimodal Control -->
                                <div class="col-md-6">
                                    <h6>Multimodal Setting</h6>
                                    <div class="card">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <span>
                                                    {% if first.supports_multimodal %}
                                                    <span class="badge bg-success">Multimodal: ON</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Multimodal: OFF</span>
                                                    {% endif %}
                                                </span>
                                                <span>
                                                    {% if first.multimodal_override is not none %}
                                                    <span class="badge bg-info">Manual Override</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Auto-detected</span>
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div>
                                                <form method="POST" action="/admin/models/toggle-multimodal" class="d-inline">
                                                    <input type="hidden" name="model_name" value="{{ model_name }}">
                                                    <button type="submit" class="btn btn-sm {{ 'btn-outline-warning' if first.supports_multimodal else 'btn-outline-success' }}">
                                                        <i class="bi {{ 'bi-toggle-on' if first.supports_multimodal else 'bi-toggle-off' }}"></i>
                                                        {{ 'Disable' if first.supports_multimodal else 'Enable' }} Multimodal
                                                    </button>
                                                </form>
                                                {% if first.multimodal_override is not none %}
                                                <form method="POST" action="/admin/models/reset-multimodal" class="d-inline">
                                                    <input type="hidden" name="model_name" value="{{ model_name }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Auto
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Architecture Details -->
                            {% if first.embedding_length or first.head_count or first.layer_count or first.feed_forward_length %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6>Architecture</h6>
                                    <div class="d-flex flex-wrap gap-3 small">
                                        {% if first.embedding_length %}
                                        <div><strong>Embedding Dim:</strong> {{ '{:,}'.format(first.embedding_length) }}{% if first.embedding_length_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</div>
                                        {% endif %}
                                        {% if first.head_count %}
                                        <div><strong>Attention Heads:</strong> {{ first.head_count }}{% if first.head_count_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</div>
                                        {% endif %}
                                        {% if first.layer_count %}
                                        <div><strong>Layers:</strong> {{ first.layer_count }}{% if first.layer_count_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</div>
                                        {% endif %}
                                        {% if first.feed_forward_length %}
                                        <div><strong>FFN Size:</strong> {{ '{:,}'.format(first.feed_forward_length) }}{% if first.feed_forward_length_override is not none %} <span class="badge bg-info" style="font-size:0.6rem">override</span>{% endif %}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Edit Metadata -->
                            {% set has_any_override = first.context_length_override is not none or first.embedding_length_override is not none or first.head_count_override is not none or first.layer_count_override is not none or first.feed_forward_length_override is not none or first.capabilities_override is not none or first.family_override is not none or first.parameter_count_override is not none or first.quantization_override is not none or first.model_format_override is not none or first.parent_model_override is not none %}
                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#editMeta-{{ loop.index }}">
                                    <i class="bi bi-pencil-square"></i> Edit Metadata
                                    {% if has_any_override %}<span class="badge bg-info ms-1">overrides active</span>{% endif %}
                                </button>
                            </div>
                            <div class="collapse mb-3" id="editMeta-{{ loop.index }}">
                                <div class="card">
                                    <div class="card-body">
                                        <form method="POST" action="/admin/models/update-metadata">
                                            <input type="hidden" name="model_name" value="{{ model_name }}">
                                            <div class="row g-2">
                                                <div class="col-md-3">
                                                    <label class="form-label small">Family</label>
                                                    <input type="text" class="form-control form-control-sm{% if first.family_override is not none %} border-info{% endif %}"
                                                           name="family" value="{{ first.family_override if first.family_override is not none else (first.family or '') }}"
                                                           placeholder="e.g. llama, qwen">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Parameter Count</label>
                                                    <input type="text" class="form-control form-control-sm{% if first.parameter_count_override is not none %} border-info{% endif %}"
                                                           name="parameter_count" value="{{ first.parameter_count_override if first.parameter_count_override is not none else (first.parameter_count or '') }}"
                                                           placeholder="e.g. 70B">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Quantization</label>
                                                    <input type="text" class="form-control form-control-sm{% if first.quantization_override is not none %} border-info{% endif %}"
                                                           name="quantization" value="{{ first.quantization_override if first.quantization_override is not none else (first.quantization or '') }}"
                                                           placeholder="e.g. FP8, Q4_K_M">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Context Length</label>
                                                    <input type="number" class="form-control form-control-sm{% if first.context_length_override is not none %} border-info{% endif %}"
                                                           name="context_length" value="{{ first.context_length_override if first.context_length_override is not none else (first.context_length or '') }}"
                                                           placeholder="e.g. 131072">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Embedding Dim</label>
                                                    <input type="number" class="form-control form-control-sm{% if first.embedding_length_override is not none %} border-info{% endif %}"
                                                           name="embedding_length" value="{{ first.embedding_length_override if first.embedding_length_override is not none else (first.embedding_length or '') }}"
                                                           placeholder="e.g. 8192">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Attention Heads</label>
                                                    <input type="number" class="form-control form-control-sm{% if first.head_count_override is not none %} border-info{% endif %}"
                                                           name="head_count" value="{{ first.head_count_override if first.head_count_override is not none else (first.head_count or '') }}"
                                                           placeholder="e.g. 64">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Layers</label>
                                                    <input type="number" class="form-control form-control-sm{% if first.layer_count_override is not none %} border-info{% endif %}"
                                                           name="layer_count" value="{{ first.layer_count_override if first.layer_count_override is not none else (first.layer_count or '') }}"
                                                           placeholder="e.g. 80">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">FFN Size</label>
                                                    <input type="number" class="form-control form-control-sm{% if first.feed_forward_length_override is not none %} border-info{% endif %}"
                                                           name="feed_forward_length" value="{{ first.feed_forward_length_override if first.feed_forward_length_override is not none else (first.feed_forward_length or '') }}"
                                                           placeholder="e.g. 28672">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Format</label>
                                                    <input type="text" class="form-control form-control-sm{% if first.model_format_override is not none %} border-info{% endif %}"
                                                           name="model_format" value="{{ first.model_format_override if first.model_format_override is not none else (first.model_format or '') }}"
                                                           placeholder="e.g. gguf, safetensors">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small">Parent Model</label>
                                                    <input type="text" class="form-control form-control-sm{% if first.parent_model_override is not none %} border-info{% endif %}"
                                                           name="parent_model" value="{{ first.parent_model_override if first.parent_model_override is not none else (first.parent_model or '') }}"
                                                           placeholder="e.g. meta-llama/...">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label small">Capabilities <span class="text-muted">(comma-separated)</span></label>
                                                    {% set cap_display = '' %}
                                                    {% if first.capabilities_override is not none %}
                                                        {% set cap_list = first.capabilities_override | fromjson if first.capabilities_override is string else [] %}
                                                        {% set cap_display = cap_list | join(', ') %}
                                                    {% elif first.capabilities %}
                                                        {% set cap_list = first.capabilities | fromjson if first.capabilities is string else [] %}
                                                        {% set cap_display = cap_list | join(', ') %}
                                                    {% endif %}
                                                    <input type="text" class="form-control form-control-sm{% if first.capabilities_override is not none %} border-info{% endif %}"
                                                           name="capabilities" value="{{ cap_display }}"
                                                           placeholder="e.g. completion, vision, tools">
                                                </div>
                                            </div>
                                            <div class="mt-3 d-flex gap-2">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-save"></i> Save Overrides
                                                </button>
                                                {% if has_any_override %}
                                                <button type="button" class="btn btn-sm btn-outline-warning"
                                                        onclick="document.getElementById('resetOverridesForm-{{ loop.index }}').submit()">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Reset All Overrides
                                                </button>
                                                {% endif %}
                                            </div>
                                        </form>
                                        {% if has_any_override %}
                                        <form id="resetOverridesForm-{{ loop.index }}" method="POST" action="/admin/models/reset-overrides" style="display:none">
                                            <input type="hidden" name="model_name" value="{{ model_name }}">
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Endpoints Table -->
                            <h6>Deployed Endpoints</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Backend</th>
                                            <th>Engine</th>
                                            <th>URL</th>
                                            <th>Status</th>
                                            <th>Loaded</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for m in instances %}
                                        <tr>
                                            <td>{{ m.backend.name if m.backend else '-' }}</td>
                                            <td>
                                                {% if m.backend %}
                                                <span class="badge bg-primary">{{ m.backend.engine.value }}</span>
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            <td><small class="text-muted">{{ m.backend.url if m.backend else '-' }}</small></td>
                                            <td>
                                                {% if m.backend and m.backend.status.value == 'healthy' %}
                                                <span class="badge bg-success">Healthy</span>
                                                {% elif m.backend %}
                                                <span class="badge bg-danger">{{ m.backend.status.value }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if m.is_loaded %}
                                                <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No models discovered yet. Models will appear here once backends are registered and polled.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
